function MarkdownParser(a){function b(b,c){var d=new RegExp("^("+b+")$",a);k[c]=d,l[c]=d}function c(b,c){var d=new RegExp("^("+b+")$",a);k[c]=d,m[c]=d}function d(b,c,d){p[d]||(p[d]={}),p[d][c]=new RegExp("^("+b+")$",a)}function e(a,b,c,d){var e=i;if(b in h){if(null===h[b])return void d.push({token:a,block:b,line:c});e=q[b]}if("undefined"!=typeof o[b]){var f=a.match(o[b]);f[2]&&(d.push({token:f[1],block:b+"-mark",line:c}),a=f[2],c=0)}for(var g,j=a.split(e),k=0;k<j.length;k++)g=j[k],""!=g&&(d.push({token:g,block:b,line:c}),c=0)}function f(a,b){for(var c in b)if(b.hasOwnProperty(c)&&b[c].test(a))return c;return""}var g=this;a=a?"i":"";var h,i=null,j=null,k={},l={},m={},n={},o={},p={},q={};return g.addInlineRules=function(b){var d=[];for(var e in b)if(b.hasOwnProperty(e)){var f=b[e].source;d.push(f),c(f,e)}return i=new RegExp("("+d.join("|")+")",a),this},g.addSubRules=function(b){h=b;for(var c in b)if(b.hasOwnProperty(c)){var e=b[c],f=[];for(var g in e)if(e.hasOwnProperty(g)){var i=e[g].source;d(i,g,c),f.push(i)}q[c]=new RegExp("("+f.join("|")+")",a)}return this},g.addBlockRules=function(c){var d=[];for(var e in c)if(c.hasOwnProperty(e)){var f=c[e].source;d.push(f),b(f,e)}return j=new RegExp("("+d.join("|")+")",a),this},g.addRunIn=function(a){return n=a,this},g.addMarkers=function(a){return o=a,this},g.tokenize=function(a){a=a.replace("\r","");var b,c,d=[],g=[],h=a.split(j),i=h.length,k=0;for(b=0;b<i;b++)if(""!==h[b]){var m=f(h[b],l);if(k>0&&m in n){var o=n[m].allowedBlocks;if(o&&o.indexOf(c)>=0){h[k]+=h[b],h[b]="",g[b]="";continue}}g[b]=m,k=b,c=m}var p=0;for(b=0;b<i;b++){var q=h[b];if(""!==q){var r=0;"empty"!=g[b]&&(r=p,p=0),e(q,g[b],r,d),p+=substrCount("\n",q)}}return d},g.identifyInline=function(a){var b=a.block,c=m;if(b in h){if(null===h[b])return"";c=p[b]}return f(a.token,c)},g}function documentReady(a){"loading"!=document.readyState?a():document.addEventListener("DOMContentLoaded",a)}function findBisect(a,b){var c=0,d=b.length-1,e=b[c];if(e>=a)return{val:c,part:0};var f=b[d];if(f<a)return{val:d,part:0};for(;d-c>1;){var g=c+Math.round((d-c)/2),h=b[g];h>=a?(d=g,f=h):(c=g,e=h)}return{val:c,part:(a-e)/(f-e)}}function substrCount(a,b){for(var c=-1,d=-2;d!=-1;)c++,d=b.indexOf(a,d+1);return c}function selectText(a){if(window.getSelection){var b=window.getSelection(),c=document.createRange();c.selectNodeContents(a),b.removeAllRanges(),b.addRange(c)}}function Animator(a,b){function c(a,b){var c;if(k=a,j=b,Math.abs(l)<1e-5)c=Math.PI,e=m;else{var d=(k-j)/l/m;c=d<0||d>.5?Math.PI*Math.sqrt(1-.5/d):.1;var h=(1-Math.cos(c))/c/Math.sin(c);e=(k-j)/h/l}g=c/e,f=(k-j)/(1-Math.cos(c))}var d,e,f,g,h,i=0,j=0,k=0,l=0,m=200,n=null,o=function(a){null===n&&(n=a);var j=a-n;j<e?(i=k+f*(Math.cos(g*(j-e))-1),l=f*g*Math.sin(g*(e-j)),b(i),d=requestAnimationFrame(o),p&&(c(h,i),p=!1,n=a)):(n=null,l=0,b(k),cancelAnimationFrame(d),p&&(p=!1))},p=!1;this.setPos=function(b){p=null!==n,p?h=b:(i=a(),c(b,i),d=requestAnimationFrame(o))},this.stop=function(){n=null,l=0,cancelAnimationFrame(d),p=!1}}function escapeRegExp(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ImagePreloader(){function a(){var a;a=this.status>=200&&this.status<400?this.responseText:'<svg height="24" version="1.1" width="24" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 -1028.4)"><path d="m22 12c0 5.523-4.477 10-10 10-5.5228 0-10-4.477-10-10 0-5.5228 4.4772-10 10-10 5.523 0 10 4.4772 10 10z" fill="#742600" transform="translate(0 1029.4)"/><path d="m22 12c0 5.523-4.477 10-10 10-5.5228 0-10-4.477-10-10 0-5.5228 4.4772-10 10-10 5.523 0 10 4.4772 10 10z" fill="#AB562B" transform="translate(0 1028.4)"/><path d="m7.0503 1037.8 3.5357 3.6-3.5357 3.5 1.4142 1.4 3.5355-3.5 3.536 3.5 1.414-1.4-3.536-3.5 3.536-3.6-1.414-1.4-3.536 3.5-3.5355-3.5-1.4142 1.4z" fill="#742600"/><path d="m7.0503 1036.8 3.5357 3.6-3.5357 3.5 1.4142 1.4 3.5355-3.5 3.536 3.5 1.414-1.4-3.536-3.5 3.536-3.6-1.414-1.4-3.536 3.5-3.5355-3.5-1.4142 1.4z" fill="#ecf0f1"/></g></svg>',f(this.responseURL||this.s2Url,a)}function b(b){var c=new XMLHttpRequest;return c.open("GET",b,!0),c.s2Url=b,c.onload=a,c.onerror=function(){},c.send(),c}function c(a){var b=a.match(/id=["']([^"']*)["']/g);if(!b)return a;for(var c,d,f,g=b.length;g--;)f=b[g],c=f.match(/id=["']([^"']*)["']/)[1],d="s"+e+c,a=a.replaceAll(f,'id="'+d+'"').replaceAll("#"+c,"#"+d);return e++,a}var d={},e=0;this.onLoad=function(a,c){d[a]?null!==d[a].svg&&c(a,d[a].svg,d[a].baseline):d[a]={svg:null,baseline:null,request:b(a),callback:c}};var f=function(a,b){var e=d[a];if(e){b=c(b);var f=b.match(/postMessage\((?:&quot;|")([\d\|\.\-]*)(?:&quot;|")/);if(f)var g=f&&f[1]?f[1].split("|").shift():0;else g=null;e.callback(a,b,g),e.svg=b,e.baseline=g,e.request=null,e.callback=null}};this.getImageDataFromUrl=function(a){var b=d[a];return b?b:null}}function ImageLoader(a,b){function c(){if(i==g.length){for(var a,b=0,c=i;c--;)f[c]!=g[c]&&(b++,a=c);if(1==b){if(null===k)return k=a,void(l=g[a]);if(k===a)return}}k=null,l=null}function d(){h={};for(var a=i;a--;){var b=f[a];"undefined"==typeof h[b]?h[b]=[a]:h[b].push(a)}}function e(a,b,c,d){var e="s2tex_"+a,f=document.getElementById(e),g=f.parentNode,h="1",i="fade-out"==d?"0.5":"1",k='<svg class="svg-preview" id="'+e+'" ';k+=null===c?'width="10px" height="10px" ':'style="vertical-align:'+-c+"pt; opacity: "+h+'" ';var l=document.createElement("div");l.innerHTML=b.replace("<svg ",k);var m=l.firstElementChild;l.removeChild(m),g.insertBefore(m,f),g.removeChild(f),i!=h&&(j=setTimeout(function(){document.getElementById(e).style.opacity=i},0))}var f=[],g=[],h={},i=0,j=null,k=null,l=null;this.reset=function(){f=[],i=0};var m=function(a,b,c){var d,f=h[a];if(f&&(d=f.length))for(;d--;){var g=f[d];e(g,b,c,g===k?"fade-in":"replace"),g===k&&(clearTimeout(j),k=null,l=null)}};this.getHtmlStub=function(a){f[i]=b+"//tex.s2cms.ru/svg/"+encodeURIComponent(a);var c='<span id="s2tex_'+i+'"></span>';return i++,c},this.fixDom=function(){c(),d();for(var b=i;b--;)a.onLoad(f[b],m);if(null!==k){var h=a.getImageDataFromUrl(l);null!==h&&null===h.callback&&e(k,h.svg,h.baseline,"fade-out")}g=f.slice(0)}}function ScrollMap(a){var b=null;this.reset=function(){b=[null,null]},this.getPosition=function(c,d,e){var f=c.offsetHeight,g=c.scrollTop;if(0==g)return 0;null===b[d]&&(b=a());var h=b[d].length-1;if(b[d][h]<=g+f)return b[e][h]-f;var i=f/2,j=g+i,k=findBisect(j,b[d]),l=parseFloat(b[e][k.val]*(1-k.part));return b[e][k.val+1]&&(l+=parseFloat(b[e][k.val+1]*k.part)),l-i}}function SyncScroll(a,b,c,d,e,f){var g=function(){c.setPos(a.getPosition(d,0,1))},h=function(){b.setPos(a.getPosition(e,1,0))};this.switchScrollToSrc=function(){e.removeEventListener("scroll",h),d.removeEventListener("scroll",g),d.addEventListener("scroll",g),f.id="container-block-source"},this.switchScrollToResult=function(){d.removeEventListener("scroll",g),e.removeEventListener("scroll",h),e.addEventListener("scroll",h),f.id="container-block-result"}}function debounce(a,b,c){function d(){n&&clearTimeout(n),j&&clearTimeout(j),p=0,j=n=o=void 0}function e(b,c){c&&clearTimeout(c),j=n=o=void 0,b&&(p=now(),k=a.apply(m,i),n||j||(i=m=void 0))}function f(){var a=b-(now()-l);a<=0||a>b?e(o,j):n=setTimeout(f,a)}function g(){e(s,n)}function h(){if(i=arguments,l=now(),m=this,o=s&&(n||!q),r===!1)var c=q&&!n;else{j||q||(p=l);var d=r-(l-p),e=d<=0||d>r;e?(j&&(j=clearTimeout(j)),p=l,k=a.apply(m,i)):j||(j=setTimeout(g,d))}return e&&n?n=clearTimeout(n):n||b===r||(n=setTimeout(f,b)),c&&(e=!0,k=a.apply(m,i)),!e||n||j||(i=m=void 0),k}var i,j,k,l,m,n,o,p=0,q=!1,r=!1,s=!0;if("function"!=typeof a)throw new TypeError(FUNC_ERROR_TEXT);return b=b<0?0:+b||0,"object"==typeof c&&(q=!!c.leading,r="maxWait"in c&&Math.max(+c.maxWait||0,b),s="trailing"in c?!!c.trailing:s),h.cancel=d,h}!function(a,b){"use strict";function c(b){var c=a.body;["result-as-html","result-as-htmltex","result-as-habr","result-as-src","result-as-debug"].forEach(function(a){c.classList?c.classList.remove(a):c.className=c.className.replace(new RegExp("(^|\\b)"+a.split(" ").join("|")+"(\\b|$)","gi")," ")}),c.classList?c.classList.add("result-as-"+b):c.className+=" result-as-"+b}function d(b,c,d,e,f,g,h,i,j){function k(a,b){if(b>=0&&a[b]&&a[b].children)for(var c=a[b].children.length;c--;)if("tex-block"===a[b].children[c].tag)return!0;return!1}function l(a,b,c,d,e){var f;return a[b].map&&0===a[b].level&&(f=a[b].map[0],a[b].attrPush(["class","line"]),a[b].attrPush(["data-line",f+""])),k(a,b+1)&&a[b].attrPush(["align","center"]),e.renderToken(a,b,c,d,e)}function m(a,b,c,d,e){var f="";return b>0&&"paragraph_close"===a[b-1].type&&!k(a,b-2)&&(f="\n"),f+e.renderToken(a,b,c,d,e)}function n(a,b,c,d,e){var f="";return b>0&&"paragraph_close"===a[b-1].type&&!k(a,b-2)&&(f="\n"),f}function o(a,b,c,d,e){var f="\n";return f}function p(a,b,c,d,e){return k(a,b+1)&&a[b].attrPush(["align","center"]),e.renderToken(a,b,c,d,e)}function q(a){var b=u.render(a);return b=b.replace("<spoiler ","\n<spoiler ")}var r=d(b).use(markdownitS2Tex).use(markdownitSub).use(markdownitSup),s=d(b).use(markdownitS2Tex).use(markdownitSub).use(markdownitSup),t=d(b).use(markdownitS2Tex,{noreplace:!0}).use(markdownitSub).use(markdownitSup),u=d(b).use(markdownitS2Tex,b._habr).use(markdownitSub).use(markdownitSup);r.renderer.rules.paragraph_open=r.renderer.rules.heading_open=l,s.renderer.rules.paragraph_open=s.renderer.rules.heading_open=p,u.renderer.rules.heading_open=m,u.renderer.rules.paragraph_open=n,u.renderer.rules.paragraph_close=o,r.renderer.rules.math_inline=function(a,b){return c.getHtmlStub(a[b].content)},u.renderer.rules.math_number=function(a,b){return'<img align="right" src="//tex.s2cms.ru/svg/'+a[b].content+'" />'},u.renderer.rules.fence=function(a,b,c,d,e){var f,g=a[b],h=g.info?u.utils.unescapeAll(g.info).trim():"",i="";return h&&(i=h.split(/\s+/g)[0],g.attrPush(["lang",i])),f=c.highlight?c.highlight(g.content,i)||u.utils.escapeHtml(g.content):u.utils.escapeHtml(g.content),"\n<source"+e.renderAttrs(g)+">"+f+"</source>\n"},this.getSource=f,this.setSource=function(a){g(a),this.updateResult()};var v=null,w="html";this.updateResult=function(){var b=f();if(v!==b){if(v=b,"html"===w){a.getElementsByClassName("result-html");c.reset(),h(r.render(b)),c.fixDom()}else"htmltex"===w?i("result-htmltex-content",t.render(b),"html"):"debug"===w?i("result-debug-content",JSON.stringify(s.parse(b,{references:{}}),null,2),"json"):"habr"===w?i("result-habr-content",q(b),"html"):i("result-src-content",s.render(b),"html");j(b)}},this.getDisplayedResult=function(){var a=f();return"habr"===w?u.render(a):"htmltex"===w?t.render(a):s.render(a)},this.getDisplayedResultFilename=function(){return w+".html"},e(w),this.switchView=function(a){w=a,e(a),v=null,this.updateResult()}}function e(c,d,e){var f=a.getElementsByClassName(c)[0];b.hljs?f.innerHTML=b.hljs.highlight(e,d).value:f.textContent=d}function f(b){var c=a.getElementsByClassName("result-html");c[0].innerHTML=b}function g(){for(var b,c=a.querySelectorAll(".result-html .line"),d=[],e=[0],f=[0],g=0,h=c.length;g<h;g++)b=parseInt(c[g].getAttribute("data-line")),b&&(d[b]=Math.round(c[g].offsetTop));var i=a.querySelectorAll(".ldt-pre .block-start");for(h=i.length,b=0,g=0;g<h;g++){var j=parseInt(i[g].getAttribute("data-line"));j&&(b+=j,"undefined"!=typeof d[b]&&(e.push(i[g].offsetTop),f.push(d[b])))}return e.push(a.querySelector(".ldt-pre").scrollHeight),f.push(a.querySelector(".result-html").scrollHeight),[e,f]}var h={html:!0,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!0,typographer:!0,quotes:"«»„“",_habr:{protocol:""},_highlight:!0,_strict:!1};documentReady(function(){var i=a.getElementsByClassName("source")[0],j=a.getElementsByClassName("result-html")[0],k=debounce(function(){n.recalcHeight()},100),l=new ScrollMap(g),m=new d(h,new ImageLoader(new ImagePreloader,"https:"==location.protocol?"https:":"http:"),b.markdownit,c,function(){return i.value},function(a){i.value=a,n.update()},f,e,function(a){l.reset();try{localStorage.setItem("editor_content",a)}catch(a){}});m.updateResult();var n=new TextareaDecorator(i,mdParser),o=a.getElementsByClassName("source")[0],p=new SyncScroll(l,new Animator(function(){return o.scrollTop},function(a){o.scrollTop=a}),new Animator(function(){return j.scrollTop},function(a){j.scrollTop=a}),o,j,a.getElementById("container-block")),q=debounce(m.updateResult,300,{maxWait:3e3});i.addEventListener("keyup",q),i.addEventListener("paste",q),i.addEventListener("cut",q),i.addEventListener("mouseup",q),i.addEventListener("touchstart",p.switchScrollToSrc),i.addEventListener("mouseover",p.switchScrollToSrc),j.addEventListener("touchstart",p.switchScrollToResult),j.addEventListener("mouseover",p.switchScrollToResult),p.switchScrollToSrc(),Array.prototype.forEach.call(a.getElementsByClassName("control-item"),function(b,c){b.addEventListener("click",function(){var b=this.getAttribute("data-result-as");if(b){m.switchView(b);var c=a.getElementsByClassName("result-"+b+"-content");"preview"!==b&&c.length&&setTimeout(function(){selectText(c[0])},0)}})}),a.querySelector("._download-source").addEventListener("click",function(){var a=new Blob([m.getSource()],{type:"text/markdown;charset=utf-8"});saveAs(a,"source.md")}),a.querySelector("._download-result").addEventListener("click",function(){var a=new Blob([m.getDisplayedResult()],{type:"text/html;charset=utf-8"});saveAs(a,m.getDisplayedResultFilename())}),a.querySelector("._upload-source").addEventListener("click",function(){var b=a.getElementById("fileElem");(b.onclick||b.click||function(){}).call(b)}),a.getElementById("fileElem").addEventListener("change",function(){if(this.files&&FileReader){var a=new FileReader,b=this;a.onload=function(){m.setSource(this.result),b.value=b.defaultValue},a.readAsText(this.files[0])}}),b.addEventListener("resize",function(){l.reset(),k()})})}(document,window),function(a){"use strict";function b(a,b){var c,d,e,f,g,h,i,j=a.pos,k=!0,l=!0,m=a.posMax,n=a.md.utils.isWhiteSpace,o=a.md.utils.isPunctChar,p=a.md.utils.isMdAsciiPunct;return c=b>0?a.src.charCodeAt(b-1):32,j>=m&&(k=!1),e=j-b,d=j<m?a.src.charCodeAt(j):32,g=p(c)||o(String.fromCharCode(c)),i=p(d)||o(String.fromCharCode(d)),f=n(c),h=n(d),h?k=!1:i&&(f||g||(k=!1)),f?l=!1:g&&(h||i||(l=!1)),{can_open:k,can_close:l,delims:e}}function c(a,c){return function(d,e){var f,g,h,i,j,k=d.posMax,l=d.pos,m=d.src.slice(l,l+a.length);if(m!==a)return!1;if(e)return!1;if(h=b(d,l+a.length),f=h.delims,!h.can_open)return d.pos+=f,d.pending+=d.src.slice(l,d.pos),!0;for(d.pos=l+a.length;d.pos<k;){if(j=d.src.slice(d.pos,d.pos+c.length),j===c&&(h=b(d,d.pos+c.length),h.can_close)){g=!0;break}d.md.inline.skipToken(d)}if(!g)return d.pos=l,!1;var n=!1,o="tex-inline";if(0==l){var p=d.src.substring(d.pos+c.length);n=p.match(/^\s*(\([ \t]*\S+[ \t]*\))\s*$/),(n||""==p)&&(o="tex-block")}return n&&(i=d.push("math_number","tex-number",0),i.content=n[1],i.markup="()"),d.posMax=d.pos,d.pos=l+c.length,i=d.push("math_inline",o,0),i.content=d.src.slice(d.pos,d.posMax),i.markup=a,d.pos=n?k:d.posMax+c.length,d.posMax=k,!0}}a.markdownitS2Tex=function(a,b){b="object"==typeof b?b:{};var d=b.inlineOpen||"$$",e=b.inlineClose||"$$",f=c(d,e);a.inline.ruler.before("escape","math_inline",f),a.renderer.rules.math_inline=function(c){return c="undefined"!=typeof b.protocol?b.protocol:c,function(f,g){var h=f[g].content;if(b.noreplace){var i=d+h+e;return i.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}var j=c+"//tex.s2cms.ru/svg/"+encodeURIComponent(h),k="tex-inline"===f[g].tag;return k?'<img src="'+j+'" alt="'+a.utils.escapeHtml(h)+'" />':'<img align="center" src="'+j+'" alt="'+a.utils.escapeHtml(h)+'" />'}}("https:"==location.protocol?"https:":"http:"),a.renderer.rules.math_number=function(a,b){return'<span style="float:right">'+a[b].content+"</span>"}}}(window);var mdParser=new MarkdownParser;mdParser.addBlockRules({latexBlock:/[ \t]*\$\$\n?(?:[^\n]+\n)*(?:[^\n]*[^\\\n])?\$\$(?:[ \t]*\([ \t]*\S+[ \t]*\))?[ \t]*(?:\n|$)/,empty:/(?:[ \t]*\n)+/,fence:/```[\s\S]*?(?:$|```(?:\n|$))/,reference:/\[[^\]]+\]\:[^\n]*(?:\n|$)/,header:/#{1,6} [^\n]*(?:\n|$)/,header2:/[^\n]+\n[ \t]*[=-]{2,}(?:\n|$)/,rule:/(?:[\*]{3,}|[\-]{3,}|[\_]{3,})(?:\n|$)/,list:/[ ]{0,3}(?:[+\-\*]|\d+\.)[ \t]+[^\n]*(?:\n[ \t]*[^\n\t ]+[ \t]*)*(?:\n|$)/,quote:/[ ]{0,3}>[^\n]*(?:\n|$)/,paragraph:/[\s\S]*?(?:\n|$)/}).addInlineRules({latex:/\$\$(?:[\s\S]*?[^\\])?\$\$/,link:/\[.+?\][\(\[].*?[\)\]]/,bold:/(?:\s|^)__[\s\S]*?\S__|\*\*[\s\S]*?\S\*\*/,italic:/(?:\s|^)_[\s\S]*?[^\\\s]_|\*[^\\\s]\*|\*\S[\s\S]*?[^\\\s]\*/,strike:/~~.+?~~/,sup:/\^.+?\^/,sub:/~.+?~/,code:/``.+?``|`.*?[^`\\]`(?!`)/}).addSubRules({fence:null,rule:null,latexBlock:{comment:/%[^\n]*?(?=\$\$)|%[^\n]*/,reference:/[ \t]*\([ \t]*\S+[ \t]*\)[ \t\n]*$/,index:/(?:\^|_)(?:\\[a-zA-Zа-яА-я]+[\*]?(?:\{.*?\})|\{[a-zA-Zа-яА-я0-9]*?\}|[a-zA-Zа-яА-я0-9])/,bracket:/(?:(?:\\left|\\right)?[\{\}\[\]\(\)\|])/,keyword:/\\[a-zA-Zа-яА-я]+[\*]?/,keyword2:/\\[^a-zA-Zа-яА-я0-9]/,keyword3:/&/,delimeter:/\$\$/}}).addRunIn({paragraph:{allowedBlocks:["paragraph","quote","list"]}}).addMarkers({list:/^([ ]{0,3}(?:[+\-\*]|\d+\.)[ \t]+)([\s\S]*)$/,quote:/^([ ]{0,3}(?:>[ \t]*)+)([\s\S]*)$/}),String.prototype.replaceAll=function(a,b){var c=this;return c.replace(new RegExp(escapeRegExp(a),"g"),b)};var now=Date.now||function(){return(new Date).getTime()};